name: Jira Status Update

on:
  workflow_run:
    workflows: ["PR Title Check"]
    types:
      - completed

jobs:
  update-jira-status:
    runs-on: ubuntu-latest
    # Only run if PR title check passed
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get PR information
        id: get-pr
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.workflow_run.pull_requests[0]?.number;
            if (!prNumber) {
              console.log('No PR associated with this workflow run');
              core.setOutput('has_pr', 'false');
              return;
            }

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            core.setOutput('has_pr', 'true');
            core.setOutput('pr_title', pr.title);
            console.log(`PR Title: ${pr.title}`);

      - name: Check if Jira ticket exists in PR title
        if: steps.get-pr.outputs.has_pr == 'true'
        id: check-jira
        run: |
          PR_TITLE="${{ steps.get-pr.outputs.pr_title }}"
          # Remove [HOTFIX] prefix if present
          PR_TITLE=$(echo "$PR_TITLE" | sed 's/^\[HOTFIX\] //')

          if [[ $PR_TITLE =~ ^(NUCLEUS|AUTO)-[0-9]+_ ]]; then
            echo "has_jira=true" >> $GITHUB_OUTPUT
            echo "✅ Jira ticket found in PR title"
          else
            echo "has_jira=false" >> $GITHUB_OUTPUT
            echo "ℹ️  No Jira ticket in PR title, skipping update"
          fi

      - name: Update Jira Status to Code Review
        if: steps.check-jira.outputs.has_jira == 'true'
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          bash .github/scripts/update-jira-status.sh \
            "${{ steps.get-pr.outputs.pr_title }}" \
            "$JIRA_BASE_URL" \
            "$JIRA_EMAIL" \
            "$JIRA_API_TOKEN"

